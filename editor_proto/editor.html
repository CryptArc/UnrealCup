<!DOCTYPE html>
<html>
    <head>
        <title>UC-Editor</title>
        <link rel="stylesheet" type="text/css" href="editor.css"/>
        
        <script src="jsPlumb-1.7.2\dist\js\dom.jsPlumb-1.7.2-min.js "></script>
        <script type="text/javascript">
            var counter = 0;
            
            // Parse the XML-File to get possible blocks
            function parseXml() {
                xmlhttp=new XMLHttpRequest();
                xmlhttp.open("GET","blocks.xml",false);
                xmlhttp.send();
                xmlDoc=xmlhttp.responseXML;
                
                var blocks = xmlDoc.getElementsByTagName("block");
                for(var i=0; i < blocks.length; i++)
                {
                    var current = blocks[i];
                    var name = current.getAttribute("name");
                    var inputs = current.getElementsByTagName("input");
                    var outputs = current.getElementsByTagName("output");
                    addBlockFactory(name, inputs, outputs);
                }
            }
            
            // TODO: Create the BlockFactory for the getBlock-Div
            function addBlockFactory(name, inputList, outputList)
            {
                var returnNode = document.createElement("div");
                returnNode.className = "blockFactory";
                returnNode.id = name;
                returnNode.setAttribute("draggable", "true");
                returnNode.setAttribute("ondragstart", "drag(event)");

                var header = document.createElement("header");
                header.innerHTML = name;
                returnNode.appendChild(header);
                
                var table = document.createElement("table");
                
                //inputs
                if(inputList.length > 0)
                {
                    for(var i=0; i<inputList.length; i++)
                    {
                        var row = table.appendChild(document.createElement("tr"));
                        
                        // TODO: Append connector
                        var td = document.createElement("td");
                        td.innerHTML = ">";
                        row.appendChild(td);
                        var current = inputList[i];
                        
                        // TODO: Set type of input
                        var setting = document.createElement("input");
                        setting.setAttribute("type", "text");
                        setting.setAttribute("placeholder", current.childNodes[0].nodeValue);
                        
                        td = document.createElement("td");
                        td.appendChild(setting);
                        row.appendChild(td);
                    }
                }
                
                //outputs
                if(outputList.length > 0)
                {   
                    for(var i=0; i<outputList.length; i++)
                    {
                        var row = table.appendChild(document.createElement("tr"));
                        
                        var current = outputList[i];
                        
                        // TODO: Set type of input
                        var td = document.createElement("td");
                        td.innerHTML = current.childNodes[0].nodeValue;
                        row.appendChild(td);
                        
                        // TODO: Append connector
                        td = document.createElement("td");
                        td.innerHTML = ">";
                        row.appendChild(td);
                    }
                }
                
                returnNode.appendChild(table);
                document.getElementById("additionalBlocks").appendChild(returnNode);
            }
            
            // AllowDrop function
            function allowDrop(ev) {
                ev.preventDefault();
            }
            
            // drag function -> save id of dragged element
            function drag(ev) {
                ev.dataTransfer.setData("text", ev.target.id);
            }
            
            // drop function of edit div
            // if blockFactory -> create block
            // if block -> change block position
            function drop(ev) {
                counter++;
                ev.preventDefault();
                var data = ev.dataTransfer.getData("text");
                var selected = document.getElementById(data);
                if(!(ev.target == selected))
               {
                    var rect = ev.target.getBoundingClientRect();
                    var x = ev.pageX - rect.left;
                    var y = ev.pageY - rect.top;

                    if(selected.className.indexOf("Factory") != -1)
                    {
                        var node = createBlock(data);
                        ev.target.appendChild(node);
                        placeDiv(x,y,node);
                    }
                    else placeDiv(x,y,selected);
               }
            }
            
            // drop function of delete div
            // delete the dropped element
            function deleteMe(ev) {
                ev.preventDefault();
                var data = ev.dataTransfer.getData("text");
                var selected = document.getElementById(data);
                selected.parentElement.removeChild(selected);
            }
            
            // TEST
            function dropCon(ev) {
                ev.preventDefault();
                var data = ev.dataTransfer.getData("text");
                var connectorA = document.getElementById(data);
                var connectorB = ev.target.getBoundingClientRect();
                
                jsPlumb.connect(connectorA, connectorB);
            }
            
            // create a new Block from a blockFactory
            function createBlock(data)
            {
                var returnNode = document.createElement("div");
                returnNode.className = "block";
                returnNode.id = data + "_" + parseInt(counter); /* We cannot use the same ID */
                returnNode.setAttribute("draggable", "true");
                returnNode.setAttribute("ondragstart", "drag(event)");

                var current = document.getElementById(data);
                for(var child = current.firstChild; child; child = child.nextSibling)
                {
                    returnNode.appendChild(child.cloneNode(true));
                }
                
                /*var connectionOut = document.createElement("div");
                connectionOut.className = "conOut";
                connectionOut.id = returnNode.id + "_out";
                connectionOut.setAttribute("draggable", "true");
                connectionOut.setAttribute("ondragstart", "drag(event)");
                returnNode.appendChild(connectionOut);
                
                var connectionIn = document.createElement("div");
                connectionIn.className = "conIn";
                connectionIn.id = returnNode.id + "_in";
                connectionIn.setAttribute("ondragover", "allowDrop(event)");
                connectionIn.setAttribute("ondrop", "dropCon(event)");
                returnNode.appendChild(connectionIn);*/
                
                return returnNode;
            }
            
            // set the position of an element
            function placeDiv(x_pos, y_pos, element) {
                element.style.position = "absolute";
                element.style.left = x_pos+'px';
                element.style.top = y_pos+'px';
            }
        </script>
    </head>
    <body onload="parseXml()">
        <header>
            <h1>UC-Editor</h1>
        </header>
        <section id="mainSection">
            <div id="getBlockDiv">
                <h2>Add Blocks:</h2>
                <details>
                    <summary>Standard Blocks</summary>
                    <div class="blockFactory" id="for" draggable="true" ondragstart="drag(event)">
                    <header>for</header>
                    <table>
                        <tr>
                            <td>></td>
                            <td><input type="text" placeholder="start"/></td>
                        </tr>
                        <tr>
                            <td>></td>
                            <td><input type="text" placeholder="end"/></td>
                        </tr>
                        <tr>
                            <td>></td>
                            <td><input type="text" placeholder="increment"/></td>
                        </tr>
                    </table>
                </div>
                </details>
                <details id="additionalBlocks">
                    <summary>Additional Blocks</summary>
                </details>
            </div>
            <div id="secondDiv">
                <div id="editDiv" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h2>edit here:</h2>
                </div>
                <div id="deleteDiv" ondrop="deleteMe(event)" ondragover="allowDrop(event)">
                    <h2>delete blocks:</h2>
                </div>
            </div>
        </section>
        <section id="submitSection">
            <input type="button" value="Done!">
        </section>
        <footer>
            UnrealCup 2015
        </footer>
    </body>
</html>